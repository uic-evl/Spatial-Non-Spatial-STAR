<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .grow rect {
        stroke: black;
        shape-rendering: crispEdges;
        fill: none;
    }


    .axis text {
        font: 40px sans-serif;
    }

    .legend text {
        font: 40px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .x.axis path,
    .x.axis line {
        display: none;
    }


    .y.axis path,
    .y.axis line {
        display: none;
    }


</style>
<svg class="chart"></svg>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

    function wrap(text, width) {
        text.each(function() {
            var text = d3.select(this),
                    words = text.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy")),
                    tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");

            console.log(words);

            while (word = words.pop()) {

                line.push(word);
                tspan.text(line.join(" "));

                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                }
            }
        });
    }

    var totWidth = 1600,
            totHeight = totWidth * 0.85,
            margin = {top: 50, right: 0, bottom: 250, left: 500},
            width = totWidth - (margin.left + margin.right),
            height = totHeight - (margin.top + margin.bottom);

    var x = d3.scale.ordinal()
            .rangeRoundBands([0, width]);

    var y = d3.scale.ordinal()
            .rangeRoundBands([height, 20]);

    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

    var chart = d3.select(".chart")
            .attr("width", totWidth)
            .attr("height", totHeight)
            .append("g")
            .attr("transform","translate("+margin.left+",0)")
            ;

    d3.tsv("encodings.tsv"/*, type*/, function(error, data) {

        var grpNames = d3.keys(data[0]).filter(function(key) { return key !== "Encoding"; });

        data.forEach(function(d) {
            d.groups = grpNames.map(function(name) { return {name: name, value: +d[name]}; });
        });

        y.domain(data.map(function(d) { return d.Encoding; }));
        var allcols = Object.keys(data[0]),
                cols = allcols.slice(1,allcols.length);
        x.domain(grpNames);

        chart.append("text")
                .attr("x", (width/2.5))
                .attr("y", (height + margin.bottom+ 20 ))
                .attr("text-anchor", "start")
                .style("font-size", "60px")
                .style("text-decoration", "bold")
//                .style("text-decoration", "underline")
                .text("Bioinformatics");


        chart.append("g")
                .attr("class","x axis")
                .attr("transform","translate(0," + (height) + ")")
                .call(xAxis)
                .selectAll("text")
                .style("text-anchor","end")
                .attr("transform","rotate(-90)")
                .attr("dx","1.0em")
                .attr("dy",x.rangeBand()/10+20)
        ;

        chart.append("g")
                .attr("class","y axis")
                .call(yAxis)
                .selectAll("text")
                .attr("dx","40px")
                .selectAll(".tick text")
        ;
//                .call(wrap, y.rangeBand());

        var grows = chart.selectAll(".grow")
                .data(data)
                .enter().append("g")
                .attr("class","grow")
                .attr("transform", function(d) { return "translate(25," + y(d.Encoding) + ")"; })
                ;

        var gcells = grows.selectAll(".gcell")
                .data(function(d) { return d.groups; })
                .enter() .append("g")
                .attr("transform", function(d,i,j) {return "translate(" + i*x.rangeBand() + ",0)" ; } )
                .attr("class","gcell")
                ;


        rmax = Math.min(y.rangeBand()/2-4,x.rangeBand()/2-4);

        gcells.append("circle")
                .attr("cy",y.rangeBand()/2)
                .attr("cx",x.rangeBand()/2)
                .attr("r", function(d) {
                            var rind = d.value;
                            var rad = rmax / ((-1)*(rind - 5));

                            return rad;//(rad > 0) ? rad : 0;
                        }
                )
                .style("fill", function(d) {
                            var gbval = 1+Math.floor(255 - (255/4*(d.value)));
                            return "rgb(" + 255 + "," + gbval + "," + gbval + ")";
                        }
                )
                .style("")
            //.style("stroke","black")
        ;

        var image = new Image;
        image.src = "Engineering.png";

        image.onload = function() {
            context.drawImage(image, 0, 0);

            var a = document.createElement("a");
            a.download = "fallback.png";
            a.href = canvas.toDataURL("image/png");
            a.click();
        };


    });


</script>